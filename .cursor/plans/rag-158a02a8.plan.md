<!-- 158a02a8-8375-4bfb-b612-0c9afb6a8fbd 66c1d614-b3c3-47f0-9fbe-50710bebceb9 -->
# Add and run unit tests for rag_engine (WSL, real providers)

### Assumptions

- Real providers allowed (Gemini/OpenRouter already in .env); tests must stay deterministic and skip gracefully when keys missing or offline.
- WSL Python 3.11 with `.venv-wsl` is the execution target.
- No destructive edits to existing modules; tests rely on tmp_path, temp Chroma dirs, and fixture data only.
- References: [Habr RAG tutorial](https://habr.com/ru/articles/955798/).

### Alignment with Phase 1 and master plans

- Validate chunker stays at 500 tokens with 150 overlap (Phase 1 hybrid design).
- Ensure metadata includes `source_file`, anchors, and citation fields for article-level context (Phase 1/ master spec).
- Confirm retriever uses chunk-level rerank + article assembly with dynamic token limits from `llm_manager`.
- Cover optional MkDocs export script from Phase 1 master plan without mutating external repos.
- Verify LangChain-pure LLM manager behaviors: streaming, fallback providers, prompt discipline, citation formatting.

### What we will add

- `rag_engine/tests/_fixtures/` containing two small markdown docs, a combined MD file, and minimal manifest JSON for MkDocs mode.
- Pytest-based unit tests per module with tmp_path fixtures; mark external/slow scenarios.
- Lightweight smoke tests for live LLM and FRIDA embedding when keys/models available, with auto-skip otherwise.
- Pytest marker configuration (external/slow) if missing.

### Tests by area

- config (`rag_engine/config/settings.py`): load defaults vs `.env`; env var overrides; case-insensitive keys.
- core: `document_processor.py` (folder/file/mkdocs fallback, absolute source paths); `chunker.py` (500/150 tokens, no truncated code fences); `metadata_enricher.py` (Phase 1 metadata contract including anchors/has_code).
- retrieval: `embedder.py` (FRIDA prefixes, deterministic dims); `vector_search.py` (top-K, metadata filter pass-through); `reranker.py` (prioritized model vs identity fallback logging); `retriever.py` (chunk → rerank → article load → context budgeting via `llm_manager.get_current_llm_context_window()`).
- storage: `vector_store.py` (temp persist dir, add/upsert/query/delete, metadata roundtrip, clean teardown).
- llm: `llm_manager.py` (context window lookup, streaming + fallback generate, provider switch); `prompts.py` (bilingual, citation instructions, context placeholder).
- utils: `formatters.py` (citation markdown grouping, missing anchor fallback); `logging_manager.py` (logger config applied without duplicating handlers).
- api: `api/app.py` (ChatInterface instantiation, streaming handler yields progressively, `query_rag` returns markdown with stubbed retriever).
- scripts: `scripts/build_index.py` (CLI help, dry-run indexing fixtures into temp Chroma dir); `scripts/run_mkdocs_export.py` (temp MkDocs project simulation creating manifest and compiled files; skip if `mkdocs` missing).

### Determinism & providers

- Add `pytest.mark.external` for tests requiring network/keys (FRIDA download, live LLM). Auto-skip when CI env or keys absent.
- Cap LLM smoke test tokens/timeouts; assert non-empty textual responses while guarding against provider rate limits.
- Cache FRIDA locally; mark tests xfail with clear reason if model unavailable.

### How we’ll run (WSL)

- `. .venv-wsl/bin/activate`
- `pip install -r rag_engine/requirements.txt`
- `pytest rag_engine/tests -q`
- `ruff check rag_engine/tests --fix`

### Artifacts

- Markdown fixtures + manifest under `rag_engine/tests/_fixtures/`.
- Optional pytest `conftest.py` with shared fixtures/mocks (temp chroma dir, stub llm manager).
- Clear skip/xfail messages for external dependencies.

### To-dos

- [ ] Add small markdown fixtures under rag_engine/tests/_fixtures/
- [ ] Write tests for config/settings.py env loading and defaults
- [ ] Add tests for document_processor (folder/file/mkdocs fallback)
- [ ] Add tests for chunker 500/150 tokens and code fences
- [ ] Add tests for metadata_enricher minimal fields
- [ ] Add tests for FRIDA embedder loads and dims
- [ ] Add tests for Chroma vector_store CRUD with temp dir
- [ ] Add tests for vector_search top-K wrapper
- [ ] Add tests for reranker model and identity fallback
- [ ] Add end-to-end retriever tests with context budgeting
- [ ] Add llm_manager streaming/generate smoke tests with keys
- [ ] Add tests for prompts system instructions presence
- [ ] Add tests to instantiate ChatInterface and query_rag stub
- [ ] Add tests for scripts/build_index.py dry-run help and run
- [ ] Run tests in WSL venv and fix flakiness if any
- [ ] Run ruff on new tests and apply minimal fixes