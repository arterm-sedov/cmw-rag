2026-01-31 12:40:24 INFO rag_engine.utils.logging_manager - Logging initialized - console and file: logs/agent.log
2026-01-31 12:40:24 INFO rag_engine.retrieval.embedder - Creating embedder: provider=infinity, model=ai-forever/FRIDA
2026-01-31 12:40:24 INFO rag_engine.config.schemas - Loaded 9 models from registry
2026-01-31 12:40:24 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:40:25 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 12:40:26 INFO rag_engine.retrieval.retriever - Reranker type: CrossEncoderReranker
2026-01-31 12:40:26 INFO rag_engine.retrieval.retriever - RAGRetriever initialized (top_k_retrieve=20, top_k_rerank=10, reranker=enabled)
2026-01-31 12:40:26 INFO __main__ - Gradio static allowed paths: /home/asedov/cmw-rag/rag_engine/resources
2026-01-31 12:40:26 INFO __main__ - Using agent-based (LangChain) handler for chat interface
2026-01-31 12:40:26 INFO __main__ - Starting Gradio server at 0.0.0.0:7860 (share=False)
2026-01-31 12:40:26 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager started
2026-01-31 12:40:26 INFO httpx - HTTP Request: GET http://localhost:7860/gradio_api/startup-events "HTTP/1.1 200 OK"
2026-01-31 12:40:27 INFO httpx - HTTP Request: HEAD http://localhost:7860/ "HTTP/1.1 200 OK"
2026-01-31 12:40:27 INFO httpx - HTTP Request: GET https://api.gradio.app/pkg-version "HTTP/1.1 200 OK"
2026-01-31 12:41:08 INFO __main__ - agent_chat_handler called: message='последний выпуск платформы', history_length=1, gradio_history_length=1
2026-01-31 12:41:08 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 12:41:08 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 12:41:08 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 12:41:08 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 12:41:08 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 12:41:09 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 12:41:09 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:41:09 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:09 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 12:41:13 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:15 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 12:41:15 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.10, user_intent_len=119, subqueries_count=7
2026-01-31 12:41:15 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 12:41:15 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:41:15 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:15 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 12:41:15 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 12:41:15 INFO rag_engine.llm.compression - Compression check: total=398 tokens (adjusted=495 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 12:41:20 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:21 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
2026-01-31 12:41:24 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 12:41:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:41:25 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:25 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:25 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:26 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:41:30 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 12:41:31 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 12:41:31 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 12:41:35 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 12:41:43 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9296736717224121, 0.8995272517204285, 0.8900399804115295])
2026-01-31 12:41:43 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:41:43 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:41:43 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:41:43 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последняя версия Comindware Platform
2026-01-31 12:41:43 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последняя версия Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:41:43 WARNING __main__ - No search_id found for query: последняя версия Comindware Platform, using fallback
2026-01-31 12:41:45 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9647533893585205, 0.9359862208366394, 0.9246872067451477])
2026-01-31 12:41:45 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:41:45 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:41:45 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:41:45 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: версии платформы Comindware
2026-01-31 12:41:45 INFO rag_engine.tools.retrieve_context - Stored query trace: query='версии платформы Comindware', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:41:45 WARNING __main__ - No search_id found for query: версии платформы Comindware, using fallback
2026-01-31 12:41:46 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.744845449924469, 0.6527554988861084, 0.5864008069038391])
2026-01-31 12:41:46 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:41:46 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:41:46 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:41:46 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: release notes Comindware Platform
2026-01-31 12:41:46 INFO rag_engine.tools.retrieve_context - Stored query trace: query='release notes Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:41:46 WARNING __main__ - No search_id found for query: release notes Comindware Platform, using fallback
2026-01-31 12:41:47 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.2416011393070221, 0.004422732628881931, 0.002858709543943405])
2026-01-31 12:41:47 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:41:47 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:41:47 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:41:47 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последний релиз платформы
2026-01-31 12:41:47 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последний релиз платформы', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:41:47 WARNING __main__ - No search_id found for query: последний релиз платформы, using fallback
2026-01-31 12:41:47 INFO rag_engine.llm.compression - Compression check: total=87630 tokens (adjusted=113896 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 12:41:58 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:42:26 INFO __main__ - Stream completed: 958 chunks processed, 4 tool results
2026-01-31 12:42:26 INFO rag_engine.tools.utils - Accumulated 17 unique articles from 4 tool call(s) (removed 3 duplicates)
2026-01-31 12:42:26 INFO __main__ - Agent completed with 17 articles
2026-01-31 12:42:26 INFO __main__ - Saved complete response to memory (3319 chars)
2026-01-31 12:42:26 INFO __main__ - Marked all pending UI spinners as done before final yield
2026-01-31 12:42:26 INFO __main__ - Final history yield: total_messages=8 (user=1, assistant=1, ui_metadata=6)
2026-01-31 12:42:26 INFO __main__ - agent_chat_handler: yielding AgentContext - sgr_plan_present=True, sgr_plan_dict_present=True, query_traces_count=4, final_articles_count=17
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: received AgentContext, starting metadata processing
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: sgr_plan present=True, plan_keys=['spam_score', 'spam_reason', 'user_intent', 'subqueries', 'action_plan', 'ask_for_clarification', 'clarification_question'], user_intent_present=True, subqueries_present=True, action_plan_present=True, user_message='последний выпуск платформы...'
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: plan extraction took 0.03ms - spam_score=0.1, user_intent_len=119, subqueries_count=7, action_plan_count=5
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: spam badge formatting took 0.01ms
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: formatting confidence badge - query_traces_count=4, has_traces=True
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: confidence badge formatting took 0.03ms
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: queries badge formatting took 0.00ms - queries_count=4
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: final formatting took 0.01ms
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: yielding badges and storing metadata in state
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: storing metadata in state - user_intent=Пользователь хочет узнать информацию о последнем в, subqueries_count=7, action_plan_count=5, articles_df_rows=17
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: badges yield and metadata storage completed, took 1.69ms
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: total metadata processing took 1.96ms
2026-01-31 12:42:26 INFO __main__ - chat_with_metadata: generator completing normally
2026-01-31 12:42:26 INFO __main__ - Re-enabling textbox and hiding stop button after handler completion
2026-01-31 12:42:27 INFO __main__ - update_metadata_ui: updating UI with metadata - has_user_intent=True, has_subqueries=True, has_action_plan=True, has_articles=True
2026-01-31 12:43:22 INFO rag_engine.utils.logging_manager - Logging initialized - console and file: logs/agent.log
2026-01-31 12:43:22 INFO rag_engine.retrieval.embedder - Creating embedder: provider=direct, model=ai-forever/FRIDA
2026-01-31 12:43:22 INFO rag_engine.config.schemas - Loaded 9 models from registry
2026-01-31 12:43:23 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 12:43:23 INFO rag_engine.retrieval.embedder - Sufficient disk space: 87.61 GB available (requires 4.00 GB)
2026-01-31 12:43:23 INFO rag_engine.retrieval.embedder - Loading embedder: ai-forever/FRIDA on cpu
2026-01-31 12:43:23 INFO sentence_transformers.SentenceTransformer - Load pretrained SentenceTransformer: ai-forever/FRIDA
2026-01-31 12:43:26 INFO sentence_transformers.SentenceTransformer - 7 prompts are loaded, with the keys: ['paraphrase', 'search_query', 'search_document', 'categorize', 'categorize_sentiment', 'categorize_topic', 'categorize_entailment']
2026-01-31 12:43:26 INFO rag_engine.retrieval.embedder - Embedder loaded. Dimension: 1536
2026-01-31 12:43:26 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:43:26 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 12:43:27 INFO rag_engine.retrieval.retriever - Reranker type: CrossEncoderReranker
2026-01-31 12:43:27 INFO rag_engine.retrieval.retriever - RAGRetriever initialized (top_k_retrieve=20, top_k_rerank=10, reranker=enabled)
2026-01-31 12:43:27 INFO __main__ - Gradio static allowed paths: /home/asedov/cmw-rag/rag_engine/resources
2026-01-31 12:43:27 INFO __main__ - Using agent-based (LangChain) handler for chat interface
2026-01-31 12:43:27 INFO __main__ - Starting Gradio server at 0.0.0.0:7860 (share=False)
2026-01-31 12:43:28 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager started
2026-01-31 12:43:28 INFO httpx - HTTP Request: GET http://localhost:7860/gradio_api/startup-events "HTTP/1.1 200 OK"
2026-01-31 12:43:28 INFO httpx - HTTP Request: HEAD http://localhost:7860/ "HTTP/1.1 200 OK"
2026-01-31 12:43:28 INFO httpx - HTTP Request: GET https://api.gradio.app/pkg-version "HTTP/1.1 200 OK"
2026-01-31 12:43:32 INFO __main__ - agent_chat_handler called: message='последний выпуск платформы', history_length=1, gradio_history_length=1
2026-01-31 12:43:32 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 12:43:32 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 12:43:32 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 12:43:32 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 12:43:32 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 12:43:32 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 12:43:32 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:43:32 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:43:32 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 12:43:33 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:43:48 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 12:43:48 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.00, user_intent_len=85, subqueries_count=5
2026-01-31 12:43:48 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 12:43:48 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 12:43:48 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:43:48 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 12:43:48 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 12:43:48 INFO rag_engine.llm.compression - Compression check: total=270 tokens (adjusted=328 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 12:43:51 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:43:52 INFO __main__ - Query available from accumulator: query='последняя версия Comindware Platform', attempting to update search_started block
2026-01-31 12:43:52 INFO __main__ - No existing block found, creating new search_started block with query='последняя версия Comindware Platform'
2026-01-31 12:43:52 INFO __main__ - YIELDING search_started bubble: query='последняя версия Comindware Platform', search_id=267b0b1f, history_len=3
2026-01-31 12:43:52 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
2026-01-31 12:43:52 INFO __main__ - Updating search_started block via tool_calls for retrieve_context: query=последняя версия Comindware Platform
2026-01-31 12:43:52 INFO __main__ - Query available from accumulator: query='текущий релиз платформы', attempting to update search_started block
2026-01-31 12:43:52 INFO __main__ - Adding new search_started block for subsequent tool call (accumulator): query='текущий релиз платформы'
2026-01-31 12:43:52 INFO __main__ - YIELDING subsequent search_started bubble: query='текущий релиз платформы', search_id=0aac1ea9, history_len=4
2026-01-31 12:43:52 INFO __main__ - Query available from accumulator: query='версии релизов платформы', attempting to update search_started block
2026-01-31 12:43:52 INFO __main__ - Adding new search_started block for subsequent tool call (accumulator): query='версии релизов платформы'
2026-01-31 12:43:52 INFO __main__ - YIELDING subsequent search_started bubble: query='версии релизов платформы', search_id=480fcaa8, history_len=5
2026-01-31 12:43:52 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 12:43:52 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 12:43:52 ERROR rag_engine.tools.retrieve_context - Error during retrieval: Could not connect to tenant default_tenant. Are you sure it exists?
Traceback (most recent call last):
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/api/client.py", line 478, in _validate_tenant_database
    self._admin_client.get_tenant(name=tenant)
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/api/client.py", line 535, in get_tenant
    return self._server.get_tenant(name=name)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/api/rust.py", line 173, in get_tenant
    tenant = self.bindings.get_tenant(name)
             ^^^^^^^^^^^^^
AttributeError: 'RustBindingsAPI' object has no attribute 'bindings'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/asedov/cmw-rag/rag_engine/tools/retrieve_context.py", line 344, in retrieve_context
    docs = await run_in_thread_pool(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/utils/thread_pool.py", line 58, in run_in_thread_pool
    return await loop.run_in_executor(executor, lambda: func(*args, **kwargs))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/utils/thread_pool.py", line 58, in <lambda>
    return await loop.run_in_executor(executor, lambda: func(*args, **kwargs))
                                                        ^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/tools/retrieve_context.py", line 345, in <lambda>
    lambda: retriever.retrieve(query, top_k=top_k, include_confidence=True)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/retrieval/retriever.py", line 199, in retrieve
    _add_candidates_for(query)
  File "/home/asedov/cmw-rag/rag_engine/retrieval/retriever.py", line 167, in _add_candidates_for
    seg_hits = top_k_search(self.store, qv, k=self.top_k_retrieve)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/retrieval/vector_search.py", line 9, in top_k_search
    return store.similarity_search(query_embedding=embedding, k=k)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/storage/vector_store.py", line 52, in similarity_search
    res = self.collection.query(
          ^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/rag_engine/storage/vector_store.py", line 30, in collection
    self._client = chromadb.PersistentClient(path=self.persist_dir)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/__init__.py", line 213, in PersistentClient
    return ClientCreator(tenant=tenant, database=database, settings=settings)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/api/client.py", line 101, in __init__
    self._validate_tenant_database(tenant=self.tenant, database=self.database)
  File "/home/asedov/cmw-rag/.venv/lib/python3.12/site-packages/chromadb/api/client.py", line 487, in _validate_tenant_database
    raise ValueError(
ValueError: Could not connect to tenant default_tenant. Are you sure it exists?
2026-01-31 12:43:52 INFO rag_engine.api.stream_helpers - Marked search_started as done for search_id=480fcaa8 (index 4)
2026-01-31 12:43:53 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:43:53 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 12:43:55 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:43:55 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:43:58 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 12:44:02 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9296736717224121, 0.8995272517204285, 0.8900399804115295])
2026-01-31 12:44:02 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:44:02 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:44:02 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:44:02 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последняя версия Comindware Platform
2026-01-31 12:44:02 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последняя версия Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:44:02 INFO rag_engine.api.stream_helpers - Marked search_started as done for search_id=267b0b1f (index 2)
2026-01-31 12:44:06 INFO rag_engine.retrieval.retriever - Retrieved 56 chunks from vector store
2026-01-31 12:44:09 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9538184404373169, 0.8919976353645325, 0.8850665092468262])
2026-01-31 12:44:09 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 12:44:09 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 12:44:09 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 12:44:09 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: текущий релиз платформы
2026-01-31 12:44:09 INFO rag_engine.tools.retrieve_context - Stored query trace: query='текущий релиз платформы', articles=5, has_confidence=True, chunks_total=5
2026-01-31 12:44:09 INFO rag_engine.api.stream_helpers - Marked search_started as done for search_id=0aac1ea9 (index 3)
2026-01-31 12:44:09 INFO rag_engine.llm.compression - Compression check: total=27700 tokens (adjusted=35987 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 12:44:17 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 12:44:45 INFO __main__ - Stream completed: 804 chunks processed, 3 tool results
2026-01-31 12:44:45 INFO rag_engine.tools.utils - Accumulated 5 unique articles from 3 tool call(s) (removed 5 duplicates)
2026-01-31 12:44:45 INFO __main__ - Agent completed with 5 articles
2026-01-31 12:44:45 INFO __main__ - Saved complete response to memory (2317 chars)
2026-01-31 12:44:45 INFO __main__ - Marked all pending UI spinners as done before final yield
2026-01-31 12:44:45 INFO __main__ - Final history yield: total_messages=10 (user=1, assistant=1, ui_metadata=8)
2026-01-31 12:44:45 INFO __main__ - agent_chat_handler: yielding AgentContext - sgr_plan_present=True, sgr_plan_dict_present=True, query_traces_count=2, final_articles_count=5
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: received AgentContext, starting metadata processing
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: sgr_plan present=True, plan_keys=['spam_score', 'spam_reason', 'user_intent', 'subqueries', 'action_plan', 'ask_for_clarification', 'clarification_question'], user_intent_present=True, subqueries_present=True, action_plan_present=True, user_message='последний выпуск платформы...'
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: plan extraction took 0.03ms - spam_score=0.0, user_intent_len=85, subqueries_count=5, action_plan_count=3
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: spam badge formatting took 0.01ms
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: formatting confidence badge - query_traces_count=2, has_traces=True
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: confidence badge formatting took 0.03ms
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: queries badge formatting took 0.00ms - queries_count=2
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: final formatting took 0.01ms
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: yielding badges and storing metadata in state
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: storing metadata in state - user_intent=Пользователь хочет узнать информацию о последнем в, subqueries_count=5, action_plan_count=3, articles_df_rows=5
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: badges yield and metadata storage completed, took 1.69ms
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: total metadata processing took 1.95ms
2026-01-31 12:44:45 INFO __main__ - chat_with_metadata: generator completing normally
2026-01-31 12:44:45 INFO __main__ - Re-enabling textbox and hiding stop button after handler completion
2026-01-31 12:44:45 INFO __main__ - update_metadata_ui: updating UI with metadata - has_user_intent=True, has_subqueries=True, has_action_plan=True, has_articles=True
2026-01-31 13:49:30 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager shutting down
2026-01-31 13:49:37 INFO rag_engine.utils.logging_manager - Logging initialized - console and file: logs/agent.log
2026-01-31 13:49:37 INFO rag_engine.retrieval.embedder - Creating embedder: provider=direct, model=ai-forever/FRIDA
2026-01-31 13:49:37 INFO rag_engine.config.schemas - Loaded 9 models from registry
2026-01-31 13:49:37 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 13:49:37 INFO rag_engine.retrieval.embedder - Sufficient disk space: 87.59 GB available (requires 4.00 GB)
2026-01-31 13:49:37 INFO rag_engine.retrieval.embedder - Loading embedder: ai-forever/FRIDA on cpu
2026-01-31 13:49:37 INFO sentence_transformers.SentenceTransformer - Load pretrained SentenceTransformer: ai-forever/FRIDA
2026-01-31 13:49:40 INFO sentence_transformers.SentenceTransformer - 7 prompts are loaded, with the keys: ['paraphrase', 'search_query', 'search_document', 'categorize', 'categorize_sentiment', 'categorize_topic', 'categorize_entailment']
2026-01-31 13:49:40 INFO rag_engine.retrieval.embedder - Embedder loaded. Dimension: 1536
2026-01-31 13:49:40 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 13:49:40 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 13:49:41 INFO rag_engine.retrieval.retriever - Reranker type: CrossEncoderReranker
2026-01-31 13:49:41 INFO rag_engine.retrieval.retriever - RAGRetriever initialized (top_k_retrieve=20, top_k_rerank=10, reranker=enabled)
2026-01-31 13:49:41 INFO __main__ - Gradio static allowed paths: /home/asedov/cmw-rag/rag_engine/resources
2026-01-31 13:49:41 INFO __main__ - Using agent-based (LangChain) handler for chat interface
2026-01-31 13:49:41 INFO __main__ - Starting Gradio server at 0.0.0.0:7860 (share=False)
2026-01-31 13:49:42 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager started
2026-01-31 13:49:42 INFO httpx - HTTP Request: GET http://localhost:7860/gradio_api/startup-events "HTTP/1.1 200 OK"
2026-01-31 13:49:42 INFO httpx - HTTP Request: HEAD http://localhost:7860/ "HTTP/1.1 200 OK"
2026-01-31 13:49:42 INFO httpx - HTTP Request: GET https://api.gradio.app/pkg-version "HTTP/1.1 200 OK"
2026-01-31 13:50:01 INFO __main__ - agent_chat_handler called: message='Какая последнияя версия ПО?', history_length=1, gradio_history_length=1
2026-01-31 13:50:01 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 13:50:01 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 13:50:01 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 13:50:01 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 13:50:01 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 13:50:01 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 13:50:01 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 13:50:01 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 13:50:01 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 13:50:03 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:21 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 13:50:21 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.10, user_intent_len=75, subqueries_count=5
2026-01-31 13:50:21 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 13:50:21 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 13:50:21 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 13:50:21 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 13:50:21 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 13:50:21 INFO rag_engine.llm.compression - Compression check: total=289 tokens (adjusted=353 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 13:50:22 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:23 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
2026-01-31 13:50:23 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 13:50:23 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 13:50:23 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 13:50:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 13:50:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 13:50:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 13:50:24 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:24 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:27 INFO rag_engine.retrieval.retriever - Retrieved 58 chunks from vector store
2026-01-31 13:50:29 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 13:50:32 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9296736717224121, 0.8995272517204285, 0.8900399804115295])
2026-01-31 13:50:32 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 13:50:32 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 13:50:32 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 13:50:32 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последняя версия Comindware Platform
2026-01-31 13:50:32 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последняя версия Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 13:50:32 WARNING __main__ - No search_id found for query: последняя версия Comindware Platform
2026-01-31 13:50:33 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:33 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9314677715301514, 0.9314677715301514, 0.8411128520965576])
2026-01-31 13:50:33 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 13:50:33 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 13:50:33 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 13:50:33 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: версии Comindware Platform release notes
2026-01-31 13:50:33 INFO rag_engine.tools.retrieve_context - Stored query trace: query='версии Comindware Platform release notes', articles=5, has_confidence=True, chunks_total=5
2026-01-31 13:50:33 WARNING __main__ - No search_id found for query: версии Comindware Platform release notes
2026-01-31 13:50:39 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 13:50:42 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9605188965797424, 0.9474650025367737, 0.9426195621490479])
2026-01-31 13:50:42 INFO rag_engine.retrieval.retriever - Top chunks belong to 4 unique articles
2026-01-31 13:50:42 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles
2026-01-31 13:50:42 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles (uncompressed, sorted by rank)
2026-01-31 13:50:42 INFO rag_engine.tools.retrieve_context - Retrieved 4 articles for query: текущая версия Comindware Platform
2026-01-31 13:50:42 INFO rag_engine.tools.retrieve_context - Stored query trace: query='текущая версия Comindware Platform', articles=4, has_confidence=True, chunks_total=5
2026-01-31 13:50:42 WARNING __main__ - No search_id found for query: текущая версия Comindware Platform
2026-01-31 13:50:42 INFO rag_engine.llm.compression - Compression check: total=51363 tokens (adjusted=66750 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 13:50:47 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 13:50:58 INFO __main__ - Stream completed: 857 chunks processed, 3 tool results
2026-01-31 13:50:58 INFO rag_engine.tools.utils - Accumulated 9 unique articles from 3 tool call(s) (removed 5 duplicates)
2026-01-31 13:50:58 INFO __main__ - Agent completed with 9 articles
2026-01-31 13:50:58 INFO __main__ - Saved complete response to memory (2500 chars)
2026-01-31 13:50:58 INFO __main__ - Marked all pending UI spinners as done before final yield
2026-01-31 13:50:58 INFO __main__ - Final history yield: total_messages=7 (user=1, assistant=1, ui_metadata=5)
2026-01-31 13:50:58 INFO __main__ - agent_chat_handler: yielding AgentContext - sgr_plan_present=True, sgr_plan_dict_present=True, query_traces_count=3, final_articles_count=9
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: received AgentContext, starting metadata processing
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: sgr_plan present=True, plan_keys=['spam_score', 'spam_reason', 'user_intent', 'subqueries', 'action_plan', 'ask_for_clarification', 'clarification_question'], user_intent_present=True, subqueries_present=True, action_plan_present=True, user_message='Какая последнияя версия ПО?...'
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: plan extraction took 0.03ms - spam_score=0.1, user_intent_len=75, subqueries_count=5, action_plan_count=4
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: spam badge formatting took 0.01ms
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: formatting confidence badge - query_traces_count=3, has_traces=True
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: confidence badge formatting took 0.03ms
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: queries badge formatting took 0.00ms - queries_count=3
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: final formatting took 0.01ms
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: yielding badges and storing metadata in state
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: storing metadata in state - user_intent=Пользователь хочет узнать последнюю доступную верс, subqueries_count=5, action_plan_count=4, articles_df_rows=9
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: badges yield and metadata storage completed, took 1.70ms
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: total metadata processing took 1.96ms
2026-01-31 13:50:58 INFO __main__ - chat_with_metadata: generator completing normally
2026-01-31 13:50:59 INFO __main__ - Re-enabling textbox and hiding stop button after handler completion
2026-01-31 13:50:59 INFO __main__ - update_metadata_ui: updating UI with metadata - has_user_intent=True, has_subqueries=True, has_action_plan=True, has_articles=True
2026-01-31 14:24:42 INFO rag_engine.utils.logging_manager - Logging initialized - console and file: logs/agent.log
2026-01-31 14:24:42 INFO rag_engine.retrieval.embedder - Creating embedder: provider=direct, model=ai-forever/FRIDA
2026-01-31 14:24:42 INFO rag_engine.config.schemas - Loaded 9 models from registry
2026-01-31 14:24:43 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 14:24:43 INFO rag_engine.retrieval.embedder - Sufficient disk space: 87.56 GB available (requires 4.00 GB)
2026-01-31 14:24:43 INFO rag_engine.retrieval.embedder - Loading embedder: ai-forever/FRIDA on cpu
2026-01-31 14:24:43 INFO sentence_transformers.SentenceTransformer - Load pretrained SentenceTransformer: ai-forever/FRIDA
2026-01-31 14:24:45 INFO sentence_transformers.SentenceTransformer - 7 prompts are loaded, with the keys: ['paraphrase', 'search_query', 'search_document', 'categorize', 'categorize_sentiment', 'categorize_topic', 'categorize_entailment']
2026-01-31 14:24:45 INFO rag_engine.retrieval.embedder - Embedder loaded. Dimension: 1536
2026-01-31 14:24:45 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:24:45 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 14:24:46 INFO rag_engine.retrieval.retriever - Reranker type: CrossEncoderReranker
2026-01-31 14:24:46 INFO rag_engine.retrieval.retriever - RAGRetriever initialized (top_k_retrieve=20, top_k_rerank=10, reranker=enabled)
2026-01-31 14:24:46 INFO __main__ - Gradio static allowed paths: /home/asedov/cmw-rag/rag_engine/resources
2026-01-31 14:24:46 INFO __main__ - Using agent-based (LangChain) handler for chat interface
2026-01-31 14:24:46 INFO __main__ - Starting Gradio server at 0.0.0.0:7860 (share=False)
2026-01-31 14:24:47 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager started
2026-01-31 14:24:47 INFO httpx - HTTP Request: GET http://localhost:7860/gradio_api/startup-events "HTTP/1.1 200 OK"
2026-01-31 14:24:47 INFO httpx - HTTP Request: HEAD http://localhost:7860/ "HTTP/1.1 200 OK"
2026-01-31 14:24:47 INFO httpx - HTTP Request: GET https://api.gradio.app/pkg-version "HTTP/1.1 200 OK"
2026-01-31 14:25:26 INFO __main__ - Clear button clicked - clearing memory
2026-01-31 14:25:29 INFO __main__ - agent_chat_handler called: message='Какая последнияя версия ПО?', history_length=1, gradio_history_length=1
2026-01-31 14:25:29 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 14:25:29 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 14:25:29 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 14:25:29 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 14:25:29 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 14:25:29 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 14:25:29 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:25:29 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:25:29 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 14:25:31 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:25:46 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 14:25:46 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.10, user_intent_len=63, subqueries_count=5
2026-01-31 14:25:46 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 14:25:46 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:25:46 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:25:46 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 14:25:46 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 14:25:46 INFO rag_engine.llm.compression - Compression check: total=289 tokens (adjusted=353 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 14:25:47 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:25:48 INFO __main__ - No existing bubble found, creating new search bubble with query='последняя версия Comindware Platform'
2026-01-31 14:25:48 INFO __main__ - YIELDING search bubble: query='последняя версия Comindware Platform', search_id=5d6cd78a, history_len=3
2026-01-31 14:25:48 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
2026-01-31 14:25:48 INFO __main__ - Adding new search bubble for subsequent tool call: query='текущая версия Comindware Platform'
2026-01-31 14:25:48 INFO __main__ - YIELDING subsequent search bubble: query='текущая версия Comindware Platform', search_id=87882834, history_len=4
2026-01-31 14:25:49 INFO __main__ - Adding new search bubble for subsequent tool call: query='release notes Comindware Platform'
2026-01-31 14:25:49 INFO __main__ - YIELDING subsequent search bubble: query='release notes Comindware Platform', search_id=858c070d, history_len=5
2026-01-31 14:25:49 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 14:25:49 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 14:25:49 INFO chromadb.telemetry.product.posthog - Anonymized telemetry enabled. See                     https://docs.trychroma.com/telemetry for more information.
2026-01-31 14:25:49 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:25:49 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:25:49 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:25:51 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:25:51 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:25:53 INFO rag_engine.retrieval.retriever - Retrieved 58 chunks from vector store
2026-01-31 14:25:57 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9605188965797424, 0.9474650025367737, 0.9426195621490479])
2026-01-31 14:25:57 INFO rag_engine.retrieval.retriever - Top chunks belong to 4 unique articles
2026-01-31 14:25:57 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles
2026-01-31 14:25:57 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles (uncompressed, sorted by rank)
2026-01-31 14:25:57 INFO rag_engine.tools.retrieve_context - Retrieved 4 articles for query: текущая версия Comindware Platform
2026-01-31 14:25:57 INFO rag_engine.tools.retrieve_context - Stored query trace: query='текущая версия Comindware Platform', articles=4, has_confidence=True, chunks_total=5
2026-01-31 14:25:57 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=87882834, count=4 (index 3)
2026-01-31 14:25:58 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:26:05 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 14:26:09 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9296736717224121, 0.8995272517204285, 0.8900399804115295])
2026-01-31 14:26:09 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 14:26:09 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 14:26:09 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 14:26:09 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последняя версия Comindware Platform
2026-01-31 14:26:09 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последняя версия Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 14:26:09 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=5d6cd78a, count=5 (index 2)
2026-01-31 14:26:18 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 14:26:22 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9095582962036133, 0.8791536688804626, 0.7816781997680664])
2026-01-31 14:26:22 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 14:26:22 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 14:26:22 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 14:26:22 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: release notes Comindware Platform
2026-01-31 14:26:22 INFO rag_engine.tools.retrieve_context - Stored query trace: query='release notes Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 14:26:22 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=858c070d, count=5 (index 4)
2026-01-31 14:26:22 INFO rag_engine.llm.compression - Compression check: total=37303 tokens (adjusted=48472 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 14:26:29 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:26:39 INFO __main__ - Stream completed: 853 chunks processed, 3 tool results
2026-01-31 14:26:39 INFO rag_engine.tools.utils - Accumulated 11 unique articles from 3 tool call(s) (removed 3 duplicates)
2026-01-31 14:26:39 INFO __main__ - Agent completed with 11 articles
2026-01-31 14:26:39 INFO __main__ - Saved complete response to memory (2996 chars)
2026-01-31 14:26:39 INFO __main__ - Marked all pending UI spinners as done before final yield
2026-01-31 14:26:39 INFO __main__ - Final history yield: total_messages=10 (user=1, assistant=1, ui_metadata=8)
2026-01-31 14:26:39 INFO __main__ - agent_chat_handler: yielding AgentContext - sgr_plan_present=True, sgr_plan_dict_present=True, query_traces_count=3, final_articles_count=11
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: received AgentContext, starting metadata processing
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: sgr_plan present=True, plan_keys=['spam_score', 'spam_reason', 'user_intent', 'subqueries', 'action_plan', 'ask_for_clarification', 'clarification_question'], user_intent_present=True, subqueries_present=True, action_plan_present=True, user_message='Какая последнияя версия ПО?...'
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: plan extraction took 0.04ms - spam_score=0.1, user_intent_len=63, subqueries_count=5, action_plan_count=4
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: spam badge formatting took 0.01ms
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: formatting confidence badge - query_traces_count=3, has_traces=True
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: confidence badge formatting took 0.03ms
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: queries badge formatting took 0.00ms - queries_count=3
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: final formatting took 0.01ms
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: yielding badges and storing metadata in state
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: storing metadata in state - user_intent=Пользователь хочет узнать актуальную версию Comind, subqueries_count=5, action_plan_count=4, articles_df_rows=11
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: badges yield and metadata storage completed, took 1.70ms
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: total metadata processing took 2.00ms
2026-01-31 14:26:39 INFO __main__ - chat_with_metadata: generator completing normally
2026-01-31 14:26:39 INFO __main__ - Re-enabling textbox and hiding stop button after handler completion
2026-01-31 14:26:39 INFO __main__ - update_metadata_ui: updating UI with metadata - has_user_intent=True, has_subqueries=True, has_action_plan=True, has_articles=True
2026-01-31 14:27:13 INFO __main__ - Clear button clicked - clearing memory
2026-01-31 14:27:13 INFO __main__ - Memory cleared for session ced90439...
2026-01-31 14:27:17 INFO __main__ - agent_chat_handler called: message='Какая последнияя версия ПО?', history_length=1, gradio_history_length=1
2026-01-31 14:27:17 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 14:27:17 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 14:27:17 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 14:27:17 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 14:27:17 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 14:27:17 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 14:27:17 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:27:17 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:27:17 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 14:27:22 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:27:24 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 14:27:24 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.30, user_intent_len=109, subqueries_count=5
2026-01-31 14:27:24 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 14:27:24 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:27:24 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:27:24 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 14:27:24 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 14:27:24 INFO rag_engine.llm.compression - Compression check: total=341 tokens (adjusted=421 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 14:27:26 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:27:27 INFO __main__ - No existing bubble found, creating new search bubble with query='последняя версия Comindware Platform'
2026-01-31 14:27:27 INFO __main__ - YIELDING search bubble: query='последняя версия Comindware Platform', search_id=adc5d3a0, history_len=3
2026-01-31 14:27:27 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
2026-01-31 14:27:28 INFO __main__ - Adding new search bubble for subsequent tool call: query='текущая версия Comindware'
2026-01-31 14:27:28 INFO __main__ - YIELDING subsequent search bubble: query='текущая версия Comindware', search_id=487e020c, history_len=4
2026-01-31 14:27:28 INFO __main__ - Adding new search bubble for subsequent tool call: query='release notes Comindware Platform'
2026-01-31 14:27:28 INFO __main__ - YIELDING subsequent search bubble: query='release notes Comindware Platform', search_id=6c29d43d, history_len=5
2026-01-31 14:27:28 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:27:28 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:27:28 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:27:29 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:27:32 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:27:33 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 14:27:33 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:27:36 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 14:27:39 INFO rag_engine.retrieval.retriever - Retrieved 60 chunks from vector store
2026-01-31 14:27:39 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [1.228855848312378, 0.9095582962036133, 0.8791536688804626])
2026-01-31 14:27:39 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 14:27:39 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 14:27:39 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 14:27:39 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: release notes Comindware Platform
2026-01-31 14:27:39 INFO rag_engine.tools.retrieve_context - Stored query trace: query='release notes Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 14:27:39 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=6c29d43d, count=5 (index 4)
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.921903669834137, 0.9103572368621826, 0.8745097517967224])
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Top chunks belong to 4 unique articles
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Loaded 4 complete articles (uncompressed, sorted by rank)
2026-01-31 14:27:45 INFO rag_engine.tools.retrieve_context - Retrieved 4 articles for query: текущая версия Comindware
2026-01-31 14:27:45 INFO rag_engine.tools.retrieve_context - Stored query trace: query='текущая версия Comindware', articles=4, has_confidence=True, chunks_total=5
2026-01-31 14:27:45 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=487e020c, count=4 (index 3)
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Reranked to top-5 chunks (sample scores: [0.9296736717224121, 0.8995272517204285, 0.8900399804115295])
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Top chunks belong to 5 unique articles
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles
2026-01-31 14:27:45 INFO rag_engine.retrieval.retriever - Loaded 5 complete articles (uncompressed, sorted by rank)
2026-01-31 14:27:45 INFO rag_engine.tools.retrieve_context - Retrieved 5 articles for query: последняя версия Comindware Platform
2026-01-31 14:27:45 INFO rag_engine.tools.retrieve_context - Stored query trace: query='последняя версия Comindware Platform', articles=5, has_confidence=True, chunks_total=5
2026-01-31 14:27:45 INFO rag_engine.api.stream_helpers - Updated search bubble to complete: search_id=adc5d3a0, count=5 (index 2)
2026-01-31 14:27:45 INFO rag_engine.llm.compression - Compression check: total=41670 tokens (adjusted=54149 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 14:27:55 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:28:17 INFO __main__ - Stream completed: 1319 chunks processed, 3 tool results
2026-01-31 14:28:17 INFO rag_engine.tools.utils - Accumulated 11 unique articles from 3 tool call(s) (removed 3 duplicates)
2026-01-31 14:28:17 INFO __main__ - Agent completed with 11 articles
2026-01-31 14:28:17 INFO __main__ - Saved complete response to memory (3519 chars)
2026-01-31 14:28:17 INFO __main__ - Marked all pending UI spinners as done before final yield
2026-01-31 14:28:17 INFO __main__ - Final history yield: total_messages=10 (user=1, assistant=1, ui_metadata=8)
2026-01-31 14:28:17 INFO __main__ - agent_chat_handler: yielding AgentContext - sgr_plan_present=True, sgr_plan_dict_present=True, query_traces_count=3, final_articles_count=11
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: received AgentContext, starting metadata processing
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: sgr_plan present=True, plan_keys=['spam_score', 'spam_reason', 'user_intent', 'subqueries', 'action_plan', 'ask_for_clarification', 'clarification_question'], user_intent_present=True, subqueries_present=True, action_plan_present=True, user_message='Какая последнияя версия ПО?...'
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: plan extraction took 0.04ms - spam_score=0.3, user_intent_len=109, subqueries_count=5, action_plan_count=5
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: spam badge formatting took 0.01ms
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: formatting confidence badge - query_traces_count=3, has_traces=True
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: confidence badge formatting took 0.03ms
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: queries badge formatting took 0.00ms - queries_count=3
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: final formatting took 0.01ms
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: yielding badges and storing metadata in state
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: storing metadata in state - user_intent=Пользователь хочет узнать последнюю доступную верс, subqueries_count=5, action_plan_count=5, articles_df_rows=11
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: badges yield and metadata storage completed, took 1.69ms
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: total metadata processing took 1.98ms
2026-01-31 14:28:17 INFO __main__ - chat_with_metadata: generator completing normally
2026-01-31 14:28:17 INFO __main__ - Re-enabling textbox and hiding stop button after handler completion
2026-01-31 14:28:17 INFO __main__ - update_metadata_ui: updating UI with metadata - has_user_intent=True, has_subqueries=True, has_action_plan=True, has_articles=True
2026-01-31 14:42:05 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager shutting down
2026-01-31 14:42:14 INFO rag_engine.utils.logging_manager - Logging initialized - console and file: logs/agent.log
2026-01-31 14:42:14 INFO rag_engine.retrieval.embedder - Creating embedder: provider=direct, model=ai-forever/FRIDA
2026-01-31 14:42:14 INFO rag_engine.config.schemas - Loaded 9 models from registry
2026-01-31 14:42:15 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 14:42:15 INFO rag_engine.retrieval.embedder - Sufficient disk space: 87.56 GB available (requires 4.00 GB)
2026-01-31 14:42:15 INFO rag_engine.retrieval.embedder - Loading embedder: ai-forever/FRIDA on cpu
2026-01-31 14:42:15 INFO sentence_transformers.SentenceTransformer - Load pretrained SentenceTransformer: ai-forever/FRIDA
2026-01-31 14:42:18 INFO sentence_transformers.SentenceTransformer - 7 prompts are loaded, with the keys: ['paraphrase', 'search_query', 'search_document', 'categorize', 'categorize_sentiment', 'categorize_topic', 'categorize_entailment']
2026-01-31 14:42:18 INFO rag_engine.retrieval.embedder - Embedder loaded. Dimension: 1536
2026-01-31 14:42:18 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:42:18 INFO rag_engine.utils.device_utils - CUDA not available. Using CPU for embeddings.
2026-01-31 14:42:19 INFO rag_engine.retrieval.retriever - Reranker type: CrossEncoderReranker
2026-01-31 14:42:19 INFO rag_engine.retrieval.retriever - RAGRetriever initialized (top_k_retrieve=20, top_k_rerank=10, reranker=enabled)
2026-01-31 14:42:19 INFO __main__ - Gradio static allowed paths: /home/asedov/cmw-rag/rag_engine/resources
2026-01-31 14:42:19 INFO __main__ - Using agent-based (LangChain) handler for chat interface
2026-01-31 14:42:19 INFO __main__ - Starting Gradio server at 0.0.0.0:7860 (share=False)
2026-01-31 14:42:19 INFO mcp.server.streamable_http_manager - StreamableHTTP session manager started
2026-01-31 14:42:19 INFO httpx - HTTP Request: GET http://localhost:7860/gradio_api/startup-events "HTTP/1.1 200 OK"
2026-01-31 14:42:19 INFO httpx - HTTP Request: HEAD http://localhost:7860/ "HTTP/1.1 200 OK"
2026-01-31 14:42:21 INFO httpx - HTTP Request: GET https://api.gradio.app/pkg-version "HTTP/1.1 200 OK"
2026-01-31 14:45:42 INFO __main__ - agent_chat_handler called: message='Какая последнияя версия ПО?', history_length=1, gradio_history_length=1
2026-01-31 14:45:42 INFO __main__ - gradio_history contents before filtering (1 messages):
2026-01-31 14:45:42 INFO __main__ -   [0] role=user, has_metadata=True, metadata_keys=[], content_preview=<list>
2026-01-31 14:45:42 INFO __main__ - Included message [0] in agent context: role=user, content_preview=non-string
2026-01-31 14:45:42 INFO __main__ - Building agent messages: gradio_history_length=1 -> agent_messages_length=2
2026-01-31 14:45:42 INFO __main__ - SGR planning enabled, executing forced analyse_user_request tool call
2026-01-31 14:45:42 INFO __main__ - SGR planning UI bubble added to history
2026-01-31 14:45:42 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:45:42 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:45:42 INFO __main__ - Calling SGR planning LLM with 2 messages
2026-01-31 14:45:43 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:46:04 INFO __main__ - SGR planning LLM returned 1 tool calls
2026-01-31 14:46:04 INFO __main__ - SGR plan extracted from tool_call.args: spam_score=0.10, user_intent_len=66, subqueries_count=5
2026-01-31 14:46:04 INFO __main__ - SGR plan injected into agent messages (total messages: 4)
2026-01-31 14:46:04 INFO rag_engine.llm.llm_manager - LLMManager initialized: openrouter/z-ai/glm-4.7 (context: 202752 tokens)
2026-01-31 14:46:04 INFO rag_engine.llm.llm_manager - Initializing OpenRouter client: model=z-ai/glm-4.7, base_url=https://openrouter.ai/api/v1, api_key=sk-or-v1-6...
2026-01-31 14:46:04 INFO rag_engine.llm.agent_factory - RAG agent created with tool choice=optional and memory compression (threshold: 162201 tokens at 80%, keep: 2 msgs, window: 202752)
2026-01-31 14:46:04 INFO __main__ - Starting agent.astream() with 4 messages
2026-01-31 14:46:04 INFO rag_engine.llm.compression - Compression check: total=287 tokens (adjusted=351 with JSON overhead), threshold=162201 (80.0% of 202752 window)
2026-01-31 14:46:05 INFO httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-31 14:46:05 INFO __main__ - Agent calling tool(s) via token.tool_calls: 1 call(s)
